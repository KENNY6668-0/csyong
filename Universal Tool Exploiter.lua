local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local MarketplaceService = game:GetService("MarketplaceService")
local Lighting = game:GetService("Lighting")
local CoreGui = game:GetService("CoreGui")
local PhysicsService = game:GetService("PhysicsService")
local SoundService = game:GetService("SoundService")
local ContextActionService = game:GetService("ContextActionService")

local DiscordWebhookURL = ""
local ToggleKey = Enum.KeyCode.F7
local AdvancedScanKey = Enum.KeyCode.F8
local StealthKey = Enum.KeyCode.F9
local QuickScanKey = Enum.KeyCode.F10
local ExportKey = Enum.KeyCode.F11
local ServerScanKey = Enum.KeyCode.F12

local SuspiciousKeywords = {
    "cheat", "hack", "exploit", "noclip", "infjump", "speedhack", "aimbot",
    "wallhack", "triggerbot", "esp", "tracers", "autofarm", "dupe", "silentaim",
    "ragebot", "autowin", "fly", "crash", "godmode", "injection", "bypass",
    "setreadonly", "getrawmetatable", "hookmetamethod", "loadstring", "require",
    "backdoor", "getgenv", "queue_on_teleport", "setfflag", "override", "anticheat",
    "detector", "obfuscate", "protection", "blacklist", "whitelist", "warden",
    "integrity", "checksum", "verify", "sanity", "anti", "tamper", "checkcaller",
    "kick", "ban", "admin", "remoteevent", "remotefunction", "invoke", "packet",
    "flood", "synapse", "krnl", "scriptware", "delta", "fluxus", "deltaexecutor",
    "evon", "oxygen", "awp", "solara", "virus", "stealer", "keylogger",
    "serverscriptservice", "serverstorage", "sanitycheck", "velocitycheck",
    "hitbox", "teleportdetect", "antiteleport", "serverlock", "replication",
    "screenshot", "coregui", "moderator", "spectator", "adminpanel", "gui_detection"
}

local ScriptPaths = {}
local RemotePaths = {}
local ModuleData = {}
local NetworkLogs = {}
local MemoryDumps = {}
local BehaviorPatterns = {}
local ThreatList = {}
local PhysicsAnomalies = {}
local AudioEvents = {}
local ExecutionLogs = {}
local ServerLogs = {}
local AIPatterns = {}
local ScriptSignatures = {}
local PeerData = {}
local CoreGuiElements = {}
local OriginalFunctions = {}
local AllLogs = {}
local StealthMode = false
local CamouflageMode = false

local function LogToFile(category, message)
    table.insert(AllLogs, "[" .. os.date("%Y-%m-%d %H:%M:%S") .. "] [" .. category .. "] " .. message)
    if #AllLogs > 1000 then
        table.remove(AllLogs, 1)
    end
end

local function OverrideGlobalFunction(funcName, newFunc)
    if _G[funcName] then
        OriginalFunctions[funcName] = _G[funcName]
        _G[funcName] = newFunc
    end
end

local function DelayedCall(func, ...)
    local args = {...}
    task.spawn(function()
        task.wait(math.random(0.1, 0.5))
        func(unpack(args))
    end)
end

local NameSpoofTable = {}

local function GenerateSpoofedName(originalName)
    local spoofedName = originalName .. "_" .. HttpService:GenerateGUID(false):sub(1, 8)
    NameSpoofTable[originalName] = spoofedName
    return spoofedName
end

local function AnalyzeCode(code)
    local lowerCode = code:lower()
    local score = 0
    local foundKeywords = {}
    for _, keyword in ipairs(SuspiciousKeywords) do
        if lowerCode:find(keyword) then
            score = score + (string.len(keyword) > 5 and 2 or 1)
            table.insert(foundKeywords, keyword)
        end
    end
    if score >= 5 then
        return "高风险", score, foundKeywords
    elseif score >= 2 then
        return "中风险", score, foundKeywords
    elseif score > 0 then
        return "低风险", score, foundKeywords
    else
        return "安全", score, foundKeywords
    end
end

local function TryDecompile(scriptObject)
    local results = {}
    local fallback = "-- 无法反编译: 原始数据转储 --\n" .. tostring(scriptObject)
    
    if _G.dex and typeof(_G.dex.decompile) == "function" then
        local success, result = pcall(_G.dex.decompile, scriptObject)
        if success then
            table.insert(results, "Dex: " .. result)
        elseif result:find("nginx error") or result:find("temporarily unavailable") then
            table.insert(results, "Dex: 失败 - 服务器不可用或响应无效")
        else
            table.insert(results, "Dex 错误: " .. tostring(result))
        end
    end
    
    if typeof(decompile) == "function" then
        local success, result = pcall(decompile, scriptObject)
        if success then
            table.insert(results, "原生: " .. result)
        elseif result:find("nginx error") or result:find("temporarily unavailable") then
            table.insert(results, "原生: 失败 - 服务器不可用或响应无效")
        else
            table.insert(results, "原生错误: " .. tostring(result))
        end
    end
    
    if _G.syn and typeof(_G.syn.decompile) == "function" then
        local success, result = pcall(_G.syn.decompile, scriptObject)
        if success then
            table.insert(results, "Synapse: " .. result)
        elseif result:find("nginx error") or result:find("temporarily unavailable") then
            table.insert(results, "Synapse: 失败 - 服务器不可用或响应无效")
        else
            table.insert(results, "Synapse 错误: " .. tostring(result))
        end
    end
    
    if #results == 0 then
        LogToFile("反编译器", "没有可用的反编译器: " .. tostring(scriptObject))
        StarterGui:SetCore("SendNotification", {
            Title = "反编译器警告",
            Text = "没有可用的反编译器，使用原始转储。",
            Duration = 3
        })
        return fallback
    end
    
    if not table.concat(results):find("Server unavailable") then
        return table.concat(results, "\n\n")
    end
    
    LogToFile("反编译器", "由于服务器问题反编译失败: " .. tostring(scriptObject))
    StarterGui:SetCore("SendNotification", {
        Title = "反编译器错误",
        Text = "反编译期间检测到服务器问题。",
        Duration = 3
    })
    return table.concat(results, "\n\n") .. "\n\n备用:\n" .. fallback
end

local function SpoofRemoteResponse(remote, args, response)
    if not StealthMode then
        return response
    end
    local spoofedResponse
    if type(response) == "number" then
        spoofedResponse = response + math.random(-5, 5)
    elseif type(response) == "string" then
        spoofedResponse = response .. "_spoofed"
    else
        spoofedResponse = response
    end
    local logText = "伪装远程响应: " .. remote:GetFullName() .. "\n原始: " .. tostring(response) .. "\n伪装: " .. tostring(spoofedResponse)
    table.insert(ServerLogs, logText)
    LogToFile("服务器", logText)
    return spoofedResponse
end

local function StoreFinding(category, title, details)
    if category == "脚本" then
        local scriptPath = title:match("脚本:%s*(.-)%s*%[")
        if scriptPath then
            table.insert(ScriptPaths, scriptPath)
        end
    elseif category == "远程" then
        local remotePath = title:match("远程:%s*(.-)%s*%[")
        if remotePath then
            table.insert(RemotePaths, remotePath)
        end
    elseif category == "网络" then
        table.insert(NetworkLogs, title .. "\n" .. details)
    elseif category == "内存" then
        table.insert(MemoryDumps, title .. "\n" .. details)
    elseif category == "行为" then
        table.insert(BehaviorPatterns, title .. "\n" .. details)
    elseif category == "物理" then
        table.insert(PhysicsAnomalies, title .. "\n" .. details)
    elseif category == "音频" then
        table.insert(AudioEvents, title .. "\n" .. details)
    elseif category == "执行" then
        table.insert(ExecutionLogs, title .. "\n" .. details)
    elseif category == "服务器" then
        table.insert(ServerLogs, title .. "\n" .. details)
    elseif category == "核心GUI" then
        table.insert(CoreGuiElements, title .. "\n" .. details)
    end
    LogToFile(category, title .. " | " .. details)
end

local function BlockKickAttempts()
    OverrideGlobalFunction("kick", function(_, reason)
        StoreFinding("行为", "踢出尝试已阻止", "尝试踢出原因: " .. (reason or "无"))
        return nil
    end)
end

local function BlockBanAttempts()
    if getrawmetatable and setrawmetatable then
        local OriginalNamecall = getrawmetatable(game).__namecall
        local NewMetatable = {
            __namecall = function(self, ...)
                if getnamecallmethod() ~= "Ban" then
                    return OriginalNamecall(self, ...)
                end
                StoreFinding("行为", "封禁尝试已阻止", "尝试封禁: " .. tostring(self))
                return nil
            end
        }
        setrawmetatable(game, NewMetatable)
    end
end

local function ScanAntiCheatLogic()
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("Script") or descendant:IsA("LocalScript") then
            local success, code = pcall(TryDecompile, descendant)
            if success and code then
                if code:find("kick") or code:find("ban") or code:find("sanity") then
                    StoreFinding("脚本", "检测到反作弊逻辑: " .. descendant:GetFullName(), "代码片段:\n" .. code:sub(1, 500))
                end
            end
        end
    end
end

local function DetectExploitHooks()
    local env = getfenv() or _G
    local exploitFunctions = {
        "hookfunction", "hookmetamethod", "checkcaller", "newcclosure",
        "setreadonly", "getrawmetatable", "setrawmetatable", "debug.getupvalue",
        "debug.getupvalues", "debug.setupvalue", "debug.getinfo", "getfenv",
        "setfenv", "getgenv", "syn.get_thread_identity", "syn.set_thread_identity",
        "syn.queue_on_teleport", "override", "rawmetatable", "getmetatable",
        "setmetatable", "loadstring", "require", "crypt", "encrypt", "decrypt",
        "syn.crypt", "krnl.load", "getconnections", "firesignal", "getraw", "setraw"
    }
    local detectedFunctions = {}
    for _, funcName in ipairs(exploitFunctions) do
        if env[funcName] or _G[funcName] then
            table.insert(detectedFunctions, funcName)
        end
    end
    if #detectedFunctions > 0 then
        local detailsText = "检测到的漏洞/钩子函数:\n" .. table.concat(detectedFunctions, "\n")
        StoreFinding("行为", "检测到漏洞钩子", detailsText)
        table.insert(ThreatList, {
            type = "钩子",
            details = detailsText,
            status = "高风险"
        })
    end
    return detectedFunctions
end

local function MonitorNetworkCalls()
    local remotes = {}
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("RemoteEvent") or descendant:IsA("RemoteFunction") then
            table.insert(remotes, descendant)
        end
    end
    for _, remote in ipairs(remotes) do
        if remote:IsA("RemoteEvent") then
            local originalFireServer = remote.FireServer
            remote.FireServer = function(...)
                local success, jsonArgs = pcall(function()
                    return HttpService:JSONEncode({...})
                end)
                local logMessage = "网络调用: " .. remote:GetFullName() .. " 参数: " .. (success and jsonArgs or "无法序列化")
                StoreFinding("网络", "网络活动 [" .. remote.Name .. "]", logMessage)
                return originalFireServer(...)
            end
        end
    end
end

local function ScanMemory()
    if not getgc then return {} end
    local gcObjects = getgc(true)
    local findings = {}
    for _, obj in ipairs(gcObjects) do
        if type(obj) == "function" then
            local success, decompiled = pcall(TryDecompile, obj)
            if success and decompiled then
                local status, score, keywords = AnalyzeCode(decompiled)
                if status ~= "安全" then
                    local detailsText = "函数内存转储:\n" .. decompiled:sub(1, 500) .. "\n分数: " .. score .. "\n关键词: " .. table.concat(keywords, ", ")
                    StoreFinding("内存", "内存函数 [" .. status .. "]", detailsText)
                    table.insert(findings, {status = status, score = score})
                end
            end
        elseif type(obj) == "table" then
            local success, jsonData = pcall(function()
                return HttpService:JSONEncode(obj)
            end)
            if success and #jsonData > 50 then
                StoreFinding("内存", "内存中的大型表", jsonData:sub(1, 500))
                table.insert(findings, {type = "table", size = #jsonData})
            end
        end
    end
    return findings
end

local function MonitorFPS()
    local lastTick = tick()
    local lowFPSCount = 0
    RunService.Heartbeat:Connect(function()
        local currentFPS = 1 / (tick() - lastTick)
        if currentFPS < 15 then
            lowFPSCount = lowFPSCount + 1
            if lowFPSCount % 60 == 0 then
                StoreFinding("行为", "检测到低帧率", "帧率降至 " .. math.floor(currentFPS) .. "。可能存在脚本延迟。")
            end
        end
        lastTick = tick()
    end)
end

local function MonitorPhysics()
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid", 10)
    local rootPart = character:WaitForChild("HumanoidRootPart", 10)
    
    if not humanoid or not rootPart then return end
    
    local lastPosition = rootPart.Position
    local lastTime = tick()
    
    RunService.Heartbeat:Connect(function()
        if not rootPart or not rootPart.Parent then return end
        
        local currentPosition = rootPart.Position
        local currentTime = tick()
        local deltaTime = currentTime - lastTime
        
        if deltaTime > 0 then
            local distance = (currentPosition - lastPosition).Magnitude
            local speed = distance / deltaTime
            
            if speed > 100 and humanoid.WalkSpeed <= 16 then
                StoreFinding("物理", "检测到异常速度", "速度: " .. math.floor(speed) .. " studs/s\n正常行走速度: " .. humanoid.WalkSpeed)
            end
            
            if rootPart.Velocity.Magnitude > 500 then
                StoreFinding("物理", "检测到异常速度向量", "速度向量: " .. tostring(rootPart.Velocity))
            end
            
            if currentPosition.Y > 10000 or currentPosition.Y < -500 then
                StoreFinding("物理", "检测到异常位置", "Y坐标: " .. currentPosition.Y)
            end
        end
        
        lastPosition = currentPosition
        lastTime = currentTime
    end)
end

local function MonitorAudio()
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("Sound") then
            descendant.Played:Connect(function()
                if descendant.Volume > 5 then
                    StoreFinding("音频", "检测到高音量音频", "音频: " .. descendant:GetFullName() .. "\n音量: " .. descendant.Volume)
                end
            end)
        end
    end
    
    game.DescendantAdded:Connect(function(descendant)
        if descendant:IsA("Sound") then
            descendant.Played:Connect(function()
                if descendant.Volume > 5 then
                    StoreFinding("音频", "检测到新的高音量音频", "音频: " .. descendant:GetFullName() .. "\n音量: " .. descendant.Volume)
                end
            end)
        end
    end)
end

local function TrackScriptExecution()
    local scriptCount = 0
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("LocalScript") and not descendant.Disabled then
            scriptCount = scriptCount + 1
        end
    end
    
    StoreFinding("执行", "当前活动脚本数量", "活动LocalScript数量: " .. scriptCount)
    
    game.DescendantAdded:Connect(function(descendant)
        if descendant:IsA("LocalScript") or descendant:IsA("Script") then
            StoreFinding("执行", "新脚本添加", "路径: " .. descendant:GetFullName() .. "\n类型: " .. descendant.ClassName)
        end
    end)
    
    return scriptCount
end

local function ScanCoreGui()
    pcall(function()
        for _, child in ipairs(CoreGui:GetChildren()) do
            local detailsText = "名称: " .. child.Name .. "\n类型: " .. child.ClassName
            StoreFinding("核心GUI", "CoreGui元素: " .. child.Name, detailsText)
        end
    end)
end

local function SpoofCoreGuiDetection()
    if hookmetamethod and getrawmetatable and setreadonly then
        pcall(function()
            local mt = getrawmetatable(game)
            setreadonly(mt, false)
            local oldNamecall = mt.__namecall
            mt.__namecall = newcclosure(function(self, ...)
                local method = getnamecallmethod()
                if method == "FindFirstChild" or method == "FindFirstChildOfClass" then
                    local args = {...}
                    if args[1] and type(args[1]) == "string" then
                        if args[1]:lower():find("scanner") or args[1]:lower():find("exploit") then
                            return nil
                        end
                    end
                end
                return oldNamecall(self, ...)
            end)
            setreadonly(mt, true)
        end)
    end
end

local function UpdateAIPatterns(scriptPath, code, status)
    table.insert(AIPatterns, {
        path = scriptPath,
        codeHash = #code,
        status = status,
        timestamp = os.time()
    })
end

local function UpdateScriptSignatures(code)
    local signature = ""
    for i = 1, math.min(50, #code) do
        signature = signature .. string.byte(code, i)
    end
    table.insert(ScriptSignatures, signature)
end

local function UpdateServerResponseFingerprint(remotePath, success, latency, response)
    table.insert(PeerData, {
        remote = remotePath,
        success = success,
        latency = latency,
        responseType = type(response),
        timestamp = os.time()
    })
end

local function DetectNetworkEncryption()
    for _, descendant in ipairs(ReplicatedStorage:GetDescendants()) do
        if descendant:IsA("RemoteEvent") or descendant:IsA("RemoteFunction") then
            local name = descendant.Name:lower()
            if name:find("encrypt") or name:find("secure") or name:find("auth") then
                StoreFinding("服务器", "检测到加密相关远程", "路径: " .. descendant:GetFullName())
            end
        end
    end
end

local function DetectCrossServerVerification()
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("RemoteEvent") or descendant:IsA("RemoteFunction") then
            local name = descendant.Name:lower()
            if name:find("verify") or name:find("validate") or name:find("check") then
                StoreFinding("服务器", "检测到验证相关远程", "路径: " .. descendant:GetFullName())
            end
        end
    end
end

local function DetectAdminPlayers()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.MembershipType == Enum.MembershipType.Premium then
            StoreFinding("服务器", "检测到Premium玩家", "玩家: " .. player.Name)
        end
        
        pcall(function()
            if game.CreatorType == Enum.CreatorType.Group then
                if player:GetRankInGroup(game.CreatorId) >= 200 then
                    StoreFinding("服务器", "检测到高权限玩家", "玩家: " .. player.Name .. " 可能是管理员")
                end
            end
        end)
    end
end

local function TestReplicationLag()
    local startTime = tick()
    local testValue = Instance.new("IntValue")
    testValue.Name = "ReplicationTest_" .. math.random(1000, 9999)
    
    pcall(function()
        testValue.Parent = LocalPlayer.Character
    end)
    
    task.delay(0.5, function()
        local endTime = tick()
        local replicationTime = (endTime - startTime) * 1000
        StoreFinding("服务器", "复制延迟测试", "延迟: " .. math.floor(replicationTime) .. "ms")
        pcall(function() testValue:Destroy() end)
    end)
end

local function InitializeExploitSignatures()
    ModuleData = {
        {name = "Synapse X", pattern = "syn%.%w+", severity = "高"},
        {name = "Krnl", pattern = "krnl%.%w+", severity = "中"},
        {name = "Script-Ware", pattern = "scriptware%.%w+", severity = "高"},
        {name = "后门", pattern = "loadstring%(%'%w+\'%)", severity = "严重"},
        {name = "自瞄", pattern = "aimbot", severity = "高"},
        {name = "透视", pattern = "esp", severity = "中"}
    }
end

local function MonitorPlayerInstance()
    local originalLocalPlayer = Players.LocalPlayer
    spawn(function()
        while wait(1) do
            if Players.LocalPlayer ~= originalLocalPlayer then
                StoreFinding("行为", "玩家实例被篡改", "LocalPlayer 引用已被修改!")
                break
            end
        end
    end)
end

local function ScanEnvironment()
    local env = getfenv()
    for key, value in pairs(env) do
        if type(value) == "function" and not string.match(key, "^[A-Za-z_]+$") then
            StoreFinding("行为", "可疑环境函数: " .. key, "类型: " .. typeof(value))
        end
    end
end

local function MonitorMemorySpikes()
    local lastMemory = collectgarbage("count")
    RunService.Heartbeat:Connect(function()
        local currentMemory = collectgarbage("count")
        if currentMemory - lastMemory > 500 then
            StoreFinding("行为", "检测到内存峰值", "内存增加了 " .. math.floor(currentMemory - lastMemory) .. " KB")
        end
        lastMemory = currentMemory
    end)
end

local function MonitorGameUpdates()
    local placeId = game.PlaceId
    local productInfo = nil
    pcall(function()
        productInfo = MarketplaceService:GetProductInfo(placeId)
    end)
    
    if productInfo then
        spawn(function()
            while wait(300) do
                local newInfo = nil
                pcall(function()
                    newInfo = MarketplaceService:GetProductInfo(placeId)
                end)
                if newInfo and productInfo and newInfo.Updated ~= productInfo.Updated then
                    StoreFinding("行为", "游戏已更新", "新版本检测: " .. tostring(newInfo.Updated))
                    productInfo = newInfo
                end
            end
        end)
    end
end

local function SetupAntiCheatCountermeasures()
    if hookmetamethod and getrawmetatable then
        pcall(function()
            local originalIndex = getrawmetatable(game).__index
            local newMetatable = {
                __index = function(self, key)
                    if key == "GetService" then
                        return function(_, serviceName)
                            if serviceName == "VirtualUser" then
                                StoreFinding("行为", "VirtualUser访问尝试", "已部署反制措施。")
                                return nil
                            end
                            return originalIndex(self, serviceName)
                        end
                    end
                    return originalIndex(self, key)
                end
            }
            setrawmetatable(game, newMetatable)
        end)
    end
    BlockKickAttempts()
    pcall(BlockBanAttempts)
end

local function SimulateHumanInput()
    local VirtualUser = game:GetService("VirtualUser")
    spawn(function()
        while wait(math.random(50, 70)) do
            pcall(function()
                VirtualUser:CaptureController()
                VirtualUser:MoveMouse(Vector2.new(math.random(0, 1000), math.random(0, 1000)))
            end)
            StoreFinding("行为", "模拟输入", "鼠标移动以测试反作弊响应。")
        end
    end)
end

local function MonitorLighting()
    Lighting:GetPropertyChangedSignal("ClockTime"):Connect(function()
        if Lighting.ClockTime < 0 or Lighting.ClockTime > 24 then
            StoreFinding("行为", "光照漏洞", "无效的ClockTime: " .. Lighting.ClockTime)
        end
    end)
end

local function AutoSaveLogs()
    spawn(function()
        while wait(300) do
            if setclipboard then
                local exportData = {
                    Scripts = table.concat(ScriptPaths, "\n"),
                    Remotes = table.concat(RemotePaths, "\n"),
                    Network = table.concat(NetworkLogs, "\n"),
                    Memory = table.concat(MemoryDumps, "\n"),
                    Behavior = table.concat(BehaviorPatterns, "\n"),
                    Physics = table.concat(PhysicsAnomalies, "\n"),
                    Audio = table.concat(AudioEvents, "\n"),
                    Execution = table.concat(ExecutionLogs, "\n"),
                    Server = table.concat(ServerLogs, "\n"),
                    CoreGui = table.concat(CoreGuiElements, "\n"),
                    Logs = table.concat(AllLogs, "\n"),
                    AIPatterns = HttpService:JSONEncode(AIPatterns),
                    ScriptSignatures = HttpService:JSONEncode(ScriptSignatures),
                    PeerData = HttpService:JSONEncode(PeerData)
                }
                setclipboard("=== 导出数据 ===\n" .. HttpService:JSONEncode(exportData))
                StarterGui:SetCore("SendNotification", {
                    Title = "自动保存",
                    Text = "日志已自动保存到剪贴板!",
                    Duration = 3
                })
            end
        end
    end)
end

local function MonitorTeleports()
    LocalPlayer.CharacterAdded:Connect(function(character)
        local rootPart = character:WaitForChild("HumanoidRootPart", 10)
        if not rootPart then return end
        
        local lastPosition = rootPart.Position
        RunService.Heartbeat:Connect(function()
            if not rootPart or not rootPart.Parent then return end
                        local currentPosition = rootPart.Position
            if (currentPosition - lastPosition).Magnitude > 100 then
                StoreFinding("行为", "检测到传送", "从 " .. tostring(lastPosition) .. " 移动到 " .. tostring(currentPosition))
            end
            lastPosition = currentPosition
        end)
    end)
end

local function BlockScreenshotAttempts()
    spawn(function()
        while wait(1) do
            pcall(function()
                for _, child in ipairs(CoreGui:GetChildren()) do
                    if child.Name:lower():find("screenshot") or child.Name:lower():find("capture") then
                        child:Destroy()
                        StoreFinding("核心GUI", "截图尝试已阻止", "已销毁GUI: " .. child.Name)
                    end
                end
            end)
        end
    end)
end

local function SandboxExecution(code)
    local sandboxEnv = setmetatable({}, {__index = _G})
    local func, err = loadstring(code)
    if not func then
        return false, err
    end
    setfenv(func, sandboxEnv)
    local success, result = pcall(func)
    if not success then
        StoreFinding("执行", "沙盒错误", "错误: " .. result)
    end
    return success, result
end

local function RedirectDangerousCalls()
    local safeAlternatives = {
        hookmetamethod = function() return nil end,
        getrawmetatable = function() return {} end,
        loadstring = function(code) return SandboxExecution(code) end
    }
    for _, funcName in ipairs({"hookmetamethod", "getrawmetatable", "loadstring"}) do
        if _G[funcName] then
            local original = _G[funcName]
            _G[funcName] = function(...)
                StoreFinding("行为", "重定向调用: " .. funcName, "拦截的调用已重定向到安全替代方案。")
                return safeAlternatives[funcName](...)
            end
        end
    end
end

local function DetectVPNProxy()
    local startTime = tick()
    pcall(function()
        HttpService:GetAsync("https://ipinfo.io/ip")
    end)
    local latency = (tick() - startTime) * 1000
    if latency > 200 then
        StoreFinding("网络", "疑似VPN/代理检测", "高延迟: " .. math.floor(latency) .. "ms")
    end
end

local function DelayHighRiskActions()
    for _, threat in ipairs(ThreatList) do
        if threat.status == "高风险" then
            wait(math.random(1, 5))
        end
    end
end

local function BehavioralCamouflage()
    local VirtualUser = game:GetService("VirtualUser")
    spawn(function()
        while wait(math.random(5, 15)) do
            pcall(function()
                VirtualUser:CaptureController()
                VirtualUser:MoveMouse(Vector2.new(math.random(0, 1000), math.random(0, 1000)))
                VirtualUser:ClickButton1(Vector2.new(math.random(0, 1000), math.random(0, 1000)))
                VirtualUser:Button1Down(Vector2.new(math.random(0, 1000), math.random(0, 1000)))
                wait(math.random(0.1, 0.5))
                VirtualUser:Button1Up(Vector2.new(math.random(0, 1000), math.random(0, 1000)))
            end)
            StoreFinding("行为", "行为伪装", "模拟人类输入以规避检测。")
        end
    end)
end

local function RenameFunctionsForStealth()
    local functionsToRename = {
        addFinding = StoreFinding,
        tryDecompile = TryDecompile,
        scanForAnticheatsAdvanced = nil
    }
    for originalName, func in pairs(functionsToRename) do
        if func then
            local newName = GenerateSpoofedName(originalName)
            _G[newName] = func
            _G[originalName] = nil
            LogToFile("隐身", "重命名函数 " .. originalName .. " 为 " .. newName)
        end
    end
end

local function HookAntiCheatMethods()
    if hookmetamethod and getrawmetatable then
        pcall(function()
            local originalNamecall = getrawmetatable(game).__namecall
            local newMetatable = {
                __namecall = function(self, method, ...)
                    if method == "Kick" or method == "Ban" then
                        StoreFinding("行为", "反作弊操作已阻止: " .. method, "阻止了对 " .. tostring(self) .. " 的执行")
                        task.spawn(function()
                            wait(math.random(0.1, 0.3))
                            return nil
                        end)
                    elseif method == "FireServer" then
                        local args = {...}
                        local spoofedArgs = {}
                        for i, arg in ipairs(args) do
                            if type(arg) == "number" and arg > 1000 then
                                spoofedArgs[i] = math.random(10, 50)
                            else
                                spoofedArgs[i] = arg
                            end
                        end
                        local success1, json1 = pcall(function() return HttpService:JSONEncode(args) end)
                        local success2, json2 = pcall(function() return HttpService:JSONEncode(spoofedArgs) end)
                        StoreFinding("网络", "伪装FireServer: " .. self:GetFullName(), "原始: " .. (success1 and json1 or "无法序列化") .. "\n伪装: " .. (success2 and json2 or "无法序列化"))
                        return originalNamecall(self, method, unpack(spoofedArgs))
                    end
                    return originalNamecall(self, method, ...)
                end
            }
            setrawmetatable(game, newMetatable)
        end)
    end
end

local function TestServerLogic()
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("RemoteEvent") then
            local testArgs = {"exploit_test", math.huge, Vector3.new(9999, 9999, 9999)}
            pcall(function()
                descendant:FireServer(unpack(testArgs))
                local success, json = pcall(function() return HttpService:JSONEncode(testArgs) end)
                StoreFinding("服务器", "服务器逻辑测试: " .. descendant:GetFullName(), "发送: " .. (success and json or "无法序列化"))
            end)
        end
    end
end

local function ManipulateMemory()
    if _G.writeinteger or _G.writememory then
        local address = 0xDEADBEEF
        local originalValue = _G.readinteger(address)
        _G.writeinteger(address, 0xCAFEBABE)
        StoreFinding("内存", "内存已修改", "地址: " .. address .. "\n原始: " .. originalValue .. "\n新值: 0xCAFEBABE")
    else
        StoreFinding("内存", "内存操作不可用", "执行器缺乏内存操作能力。")
    end
end

local function ExploitAntiCheatWeaknesses()
    local patterns = {
        kickPattern = "game:GetService%(\"Players\"%).LocalPlayer:Kick",
        banPattern = "game:Shutdown()",
        sanityPattern = "sanitycheck"
    }
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("Script") or descendant:IsA("LocalScript") then
            local success, code = pcall(TryDecompile, descendant)
            if success and code then
                for patternName, pattern in pairs(patterns) do
                    if code:find(pattern) then
                        StoreFinding("脚本", "反作弊弱点: " .. patternName .. " 在 " .. descendant:GetFullName(), "代码:\n" .. code:sub(1, 500))
                        SandboxExecution(code:gsub(pattern, "return nil"))
                    end
                end
            end
        end
    end
end

local function DeployDefenseLayers()
    local layers = {
        function() HookAntiCheatMethods() end,
        function() RenameFunctionsForStealth() end,
        function() SpoofCoreGuiDetection() end
    }
    for i, layer in ipairs(layers) do
        task.spawn(function()
            wait(math.random(0.5, 2))
            pcall(layer)
            StoreFinding("行为", "防御层 " .. i .. " 已部署", "层已激活。")
        end)
    end
end

local function SetupAntiAFK()
    LocalPlayer.Idled:Connect(function()
        local VirtualUser = game:GetService("VirtualUser")
        pcall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new(0, 0))
        end)
        StarterGui:SetCore("SendNotification", {
            Title = "防挂机",
            Text = "防挂机已激活!",
            Duration = 3
        })
    end)
end

local function ClearAllData()
    ScriptPaths = {}
    RemotePaths = {}
    NetworkLogs = {}
    MemoryDumps = {}
    BehaviorPatterns = {}
    ThreatList = {}
    PhysicsAnomalies = {}
    AudioEvents = {}
    ExecutionLogs = {}
    ServerLogs = {}
    CoreGuiElements = {}
end

local function BasicScan()
    ClearAllData()
    local scanCount = 0
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("LocalScript") or descendant:IsA("Script") then
            StoreFinding("脚本", "脚本: " .. descendant:GetFullName() .. " [基础]", "基础扫描 - 无反编译。")
            scanCount = scanCount + 1
        elseif descendant:IsA("RemoteEvent") then
            StoreFinding("远程", "远程: " .. descendant:GetFullName() .. " [基础]", "基础扫描 - 检测到远程。")
            scanCount = scanCount + 1
        end
    end
    ScanCoreGui()
    return scanCount
end

local function QuickScan()
    ClearAllData()
    local sampleCount = 0
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("LocalScript") and math.random() < 0.1 then
            StoreFinding("脚本", "脚本: " .. descendant:GetFullName() .. " [快速]", "快速扫描 - 已采样。")
            sampleCount = sampleCount + 1
        end
    end
    ScanCoreGui()
    if sampleCount == 0 then
        StoreFinding("脚本", "快速扫描完成", "没有采样到脚本。")
    end
    return sampleCount
end

local function AdvancedScan()
    ClearAllData()
    local findingsCount = 0
    
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("LocalScript") or descendant:IsA("ModuleScript") or descendant:IsA("Script") then
            local success, err = pcall(function()
                local scriptPath = descendant:GetFullName()
                local decompiled = TryDecompile(descendant)
                local status, score, keywords = AnalyzeCode(decompiled)
                local detailsText = "路径: " .. scriptPath .. "\n状态: " .. status .. " (分数: " .. score .. ")\n关键词: " .. table.concat(keywords, ", ") .. "\n\n--- 代码 ---\n" .. decompiled:sub(1, 1000)
                DelayedCall(StoreFinding, "脚本", "脚本: " .. scriptPath .. " [" .. status .. "]", detailsText)
                findingsCount = findingsCount + 1
                if status ~= "安全" then
                    table.insert(ThreatList, {
                        type = "脚本",
                        path = scriptPath,
                        status = status
                    })
                    UpdateAIPatterns(scriptPath, decompiled, status)
                    UpdateScriptSignatures(decompiled)
                end
            end)
            if not success then
                StoreFinding("脚本", "脚本: " .. descendant:GetFullName() .. " [错误]", "扫描错误: " .. tostring(err))
            end
        end
    end
    
    if getgc then
        local gcObjects = getgc(true)
        for _, obj in ipairs(gcObjects) do
            if type(obj) == "function" and islclosure and islclosure(obj) then
                local success, err = pcall(function()
                    local decompiled = TryDecompile(obj)
                    local status, score, keywords = AnalyzeCode(decompiled)
                    local detailsText = "--- 反编译函数 ---\n" .. decompiled:sub(1, 500) .. "\n状态: " .. status .. " (分数: " .. score .. ")\n关键词: " .. table.concat(keywords, ", ")
                    DelayedCall(StoreFinding, "内存", "函数 (getgc) [" .. status .. "]", detailsText)
                    findingsCount = findingsCount + 1
                end)
                if not success then
                    StoreFinding("内存", "函数 (getgc) [错误]", "扫描错误: " .. tostring(err))
                end
            end
        end
    end
    
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("RemoteEvent") or descendant:IsA("RemoteFunction") or descendant:IsA("BindableEvent") or descendant:IsA("BindableFunction") then
            local success, err = pcall(function()
                local remotePath = descendant:GetFullName()
                local remoteName = descendant.Name:lower()
                local isSuspicious = false
                for _, keyword in ipairs(SuspiciousKeywords) do
                    if remoteName:find(keyword) then
                        isSuspicious = true
                        break
                    end
                end
                local status = isSuspicious and "可疑" or "安全"
                local detailsText = "路径: " .. remotePath .. "\n类型: " .. descendant.ClassName .. "\n状态: " .. status
                DelayedCall(StoreFinding, "远程", "远程: " .. remotePath .. " [" .. status .. "]", detailsText)
                findingsCount = findingsCount + 1
            end)
            if not success then
                StoreFinding("远程", "远程: " .. descendant:GetFullName() .. " [错误]", "扫描错误: " .. tostring(err))
            end
        end
    end
    
    ScanCoreGui()
    ScanAntiCheatLogic()
    
    if hookmetamethod then
        StoreFinding("行为", "检测到元方法钩子", "hookmetamethod 可用。可能存在钩子。")
    end
    
    if debug and debug.getupvalues then
        StoreFinding("行为", "调试函数可用", "debug.getupvalues 可访问。")
    end
    
    DetectExploitHooks()
    MonitorNetworkCalls()
    ScanMemory()
    MonitorFPS()
    pcall(MonitorPhysics)
    MonitorAudio()
    TrackScriptExecution()
    
    if findingsCount == 0 then
        StoreFinding("脚本", "分析完成", "未发现可疑元素。")
    end
    
    return findingsCount, #ThreatList
end

local function ServerScan()
    ClearAllData()
    local anomalyCount = 0
    
    for _, descendant in ipairs(game:GetDescendants()) do
        if descendant:IsA("RemoteEvent") then
            local remotePath = descendant:GetFullName()
            local originalFireServer = descendant.FireServer
            descendant.FireServer = function(...)
                local args = {...}
                local startTime = tick()
                local success, response = pcall(originalFireServer, descendant, ...)
                local latency = (tick() - startTime) * 1000
                local success2, jsonArgs = pcall(function() return HttpService:JSONEncode(args) end)
                local detailsText = "路径: " .. remotePath .. "\n参数: " .. (success2 and jsonArgs or "无法序列化") .. "\n延迟: " .. math.floor(latency) .. "ms\n响应: " .. (success and tostring(response) or "错误: " .. tostring(response))
                if latency > 50 or not success then
                    StoreFinding("服务器", "服务器远程事件: " .. remotePath .. " [可疑]", detailsText)
                    anomalyCount = anomalyCount + 1
                    UpdateServerResponseFingerprint(remotePath, success, latency, response)
                end
                if success then
                    return SpoofRemoteResponse(descendant, args, response)
                end
            end
        elseif descendant:IsA("RemoteFunction") then
            local remotePath = descendant:GetFullName()
            local originalInvokeServer = descendant.InvokeServer
            descendant.InvokeServer = function(...)
                local args = {...}
                local startTime = tick()
                local success, response = pcall(originalInvokeServer, descendant, ...)
                local latency = (tick() - startTime) * 1000
                local success2, jsonArgs = pcall(function() return HttpService:JSONEncode(args) end)
                local detailsText = "路径: " .. remotePath .. "\n参数: " .. (success2 and jsonArgs or "无法序列化") .. "\n延迟: " .. math.floor(latency) .. "ms\n响应: " .. (success and tostring(response) or "错误: " .. tostring(response))
                if latency > 50 or not success then
                    StoreFinding("服务器", "服务器远程函数: " .. remotePath .. " [可疑]", detailsText)
                    anomalyCount = anomalyCount + 1
                    UpdateServerResponseFingerprint(remotePath, success, latency, response)
                end
                if success then
                    return SpoofRemoteResponse(descendant, args, response)
                end
            end
        end
    end
    
    local function TestVelocitySanity()
        local character = LocalPlayer.Character
        local rootPart = character and character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            local originalVelocity = rootPart.Velocity
            rootPart.Velocity = Vector3.new(1000, 0, 0)
            wait(math.random(0.05, 0.15))
            if rootPart.Velocity.Magnitude < 500 then
                StoreFinding("服务器", "速度合理性检查", "服务器将速度从1000修正为 " .. math.floor(rootPart.Velocity.Magnitude))
            end
            rootPart.Velocity = originalVelocity
        end
    end
    
    local function TestSpeedHack()
        local character = LocalPlayer.Character
        local humanoid = character and character:FindFirstChild("Humanoid")
        if humanoid then
            local originalSpeed = humanoid.WalkSpeed
            humanoid.WalkSpeed = 100
            wait(math.random(0.3, 0.7))
            humanoid.WalkSpeed = originalSpeed
            StoreFinding("服务器", "速度修改测试", "模拟行走速度: 100")
            
            local rootPart = character and character:FindFirstChild("HumanoidRootPart")
            if rootPart then
                local originalPosition = rootPart.Position
                rootPart.Position = originalPosition + Vector3.new(50, 0, 50)
                wait(math.random(0.3, 0.7))
                rootPart.Position = originalPosition
                StoreFinding("服务器", "传送测试", "模拟传送: " .. tostring(originalPosition) .. " -> " .. tostring(rootPart.Position))
            end
        end
    end
    
    pcall(TestSpeedHack)
    pcall(TestVelocitySanity)
    DetectNetworkEncryption()
    DetectCrossServerVerification()
    DetectAdminPlayers()
    TestReplicationLag()
    ScanCoreGui()
    
    if anomalyCount == 0 then
        StoreFinding("服务器", "服务器扫描完成", "未检测到服务器端异常。")
    end
    
    return anomalyCount
end

local function ExportAllData()
    local exportData = {
        脚本 = table.concat(ScriptPaths, "\n"),
        远程 = table.concat(RemotePaths, "\n"),
        网络 = table.concat(NetworkLogs, "\n"),
        内存 = table.concat(MemoryDumps, "\n"),
        行为 = table.concat(BehaviorPatterns, "\n"),
        物理 = table.concat(PhysicsAnomalies, "\n"),
        音频 = table.concat(AudioEvents, "\n"),
        执行 = table.concat(ExecutionLogs, "\n"),
        服务器 = table.concat(ServerLogs, "\n"),
        核心GUI = table.concat(CoreGuiElements, "\n"),
        日志 = table.concat(AllLogs, "\n"),
        AI模式 = HttpService:JSONEncode(AIPatterns),
        脚本签名 = HttpService:JSONEncode(ScriptSignatures),
        对等数据 = HttpService:JSONEncode(PeerData)
    }
    local exportText = "=== 导出数据 ===\n" .. HttpService:JSONEncode(exportData)
    if setclipboard then
        setclipboard(exportText)
        StarterGui:SetCore("SendNotification", {
            Title = "导出",
            Text = "所有数据已导出到剪贴板!",
            Duration = 3
        })
    end
    return exportText
end

local function ToggleStealthMode()
    StealthMode = not StealthMode
    if StealthMode then
        SpoofCoreGuiDetection()
        RenameFunctionsForStealth()
    end
    return StealthMode
end

local function GetThreatSummary()
    local highRisk = 0
    local mediumRisk = 0
    local lowRisk = 0
    for _, threat in ipairs(ThreatList) do
        if threat.status == "高风险" then
            highRisk = highRisk + 1
        elseif threat.status == "中风险" then
            mediumRisk = mediumRisk + 1
        elseif threat.status == "低风险" then
            lowRisk = lowRisk + 1
        end
    end
    return {
        total = #ThreatList,
        high = highRisk,
        medium = mediumRisk,
        low = lowRisk
    }
end

local function InitializeAllSystems()
    InitializeExploitSignatures()
    MonitorPlayerInstance()
    ScanEnvironment()
    MonitorMemorySpikes()
    MonitorGameUpdates()
    SetupAntiCheatCountermeasures()
    SimulateHumanInput()
    MonitorLighting()
    AutoSaveLogs()
    MonitorTeleports()
    BlockScreenshotAttempts()
    RedirectDangerousCalls()
    DetectVPNProxy()
    DelayHighRiskActions()
    BehavioralCamouflage()
    HookAntiCheatMethods()
    TestServerLogic()
    ExploitAntiCheatWeaknesses()
    DeployDefenseLayers()
    SetupAntiAFK()
end

local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/KingScriptAE/No-sirve-nada./refs/heads/main/main.lua"))()

local function gradient(text, startColor, endColor)
    local result = ""
    local chars = {}
    for uchar in text:gmatch("[%z\1-\127\194-\244][\128-\191]*") do
        table.insert(chars, uchar)
    end
    local length = #chars
    for i = 1, length do
        local t = (i - 1) / math.max(length - 1, 1)
        local r = startColor.R + (endColor.R - startColor.R) * t
        local g = startColor.G + (endColor.G - startColor.G) * t
        local b = startColor.B + (endColor.B - startColor.B) * t
        result = result .. string.format('<font color="rgb(%d,%d,%d)">%s</font>', 
            math.floor(r * 255), 
            math.floor(g * 255), 
            math.floor(b * 255), 
            chars[i])
    end
    return result
end

local Window = WindUI:CreateWindow({
    Title = gradient("反作弊扫描器 Pro", Color3.fromHex("#FF0000"), Color3.fromHex("#00FFFF")), 
    Author = gradient("@霖溺开发", Color3.fromHex("#00FFAA"), Color3.fromHex("#00AAFF")),
    Icon = "shield",
    IconThemed = true,
    Folder = "AntiCheatScanner",
    Size = UDim2.fromOffset(350, 400),
    Transparent = true,
    Theme = "Dark",
    SideBarWidth = 180,
    HideSearchBar = false,
    ScrollBarEnabled = true,
})

Window:EditOpenButton({
    Title = "打开扫描器",
    Icon = "scan",
    CornerRadius = UDim.new(0, 10),
    StrokeThickness = 2,
    Color = ColorSequence.new(
        Color3.fromHex("FF0000"),
        Color3.fromHex("00FFFF")
    ),
    Draggable = true,
})

local Tabs = {
    InfoTab = Window:Tab({ Title = "信息", Icon = "info" }),
    ScanTab = Window:Tab({ Title = "扫描", Icon = "scan" }),
    ResultsTab = Window:Tab({ Title = "结果", Icon = "file-text" }),
    SettingsTab = Window:Tab({ Title = "设置", Icon = "settings" }),
    ToolsTab = Window:Tab({ Title = "工具", Icon = "wrench" }),
    ServerTab = Window:Tab({ Title = "服务器", Icon = "server" }),
    MemoryTab = Window:Tab({ Title = "内存", Icon = "cpu" }),
    NetworkTab = Window:Tab({ Title = "网络", Icon = "wifi" }),
    BehaviorTab = Window:Tab({ Title = "行为", Icon = "activity" }),
    ExportTab = Window:Tab({ Title = "导出", Icon = "download" }),
}

Tabs.InfoTab:Section({Title = "扫描器信息"})

Tabs.InfoTab:Paragraph({
    Title = "反作弊扫描器 Pro V4",
    Desc = "专业的反作弊与漏洞扫描工具\n支持脚本分析、内存扫描、网络监控等功能\n手机端专用优化版本",
    Image = "rbxassetid://129260712070622",
    ImageSize = 50,
    ThumbnailSize = 100
})

Tabs.InfoTab:Paragraph({
    Title = "功能特点",
    Desc = "• 脚本反编译与分析\n• 远程事件监控\n• 内存扫描\n• 物理异常检测\n• 行为模式分析\n• 服务器响应测试\n• 隐身模式",
    Image = "rbxassetid://129260712070622",
    ImageSize = 40,
    ThumbnailSize = 80
})

Tabs.InfoTab:Paragraph({
    Title = "开发者",
    Desc = "QQ: 1345639578\n由霖溺开发维护",
    Image = "https://play-lh.googleusercontent.com/7cIIPlWm4m7AGqVpEsIfyL-HW4cQla4ucXnfalMft1TMIYQIlf2vqgmthlZgbNAQoaQ",
    ImageSize = 42,
    ThumbnailSize = 100
})

Tabs.ScanTab:Section({Title = "扫描选项"})

Tabs.ScanTab:Button({
    Title = "基础扫描",
    Desc = "快速扫描脚本和远程事件",
    Callback = function()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描中",
            Text = "正在执行基础扫描...",
            Duration = 2
        })
        local count = BasicScan()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描完成",
            Text = "基础扫描完成! 发现 " .. count .. " 个项目",
            Duration = 3
        })
    end
})

Tabs.ScanTab:Button({
    Title = "高级扫描",
    Desc = "深度扫描包含反编译和分析",
    Callback = function()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描中",
            Text = "正在执行高级扫描，请稍候...",
            Duration = 3
        })
        local findings, threats = AdvancedScan()
        StarterGui:SetCore("SendNotification", {
            Title = "高级扫描完成",
            Text = "发现: " .. findings .. " 个项目\n威胁: " .. threats .. " 个",
            Duration = 5
        })
    end
})

Tabs.ScanTab:Button({
    Title = "快速扫描",
    Desc = "随机采样扫描，速度更快",
    Callback = function()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描中",
            Text = "正在执行快速扫描...",
            Duration = 2
        })
        local count = QuickScan()
        StarterGui:SetCore("SendNotification", {
            Title = "快速扫描完成",
            Text = "采样扫描完成! 采样 " .. count .. " 个脚本",
            Duration = 3
        })
    end
})

Tabs.ScanTab:Button({
    Title = "服务器扫描",
    Desc = "测试服务器端验证和响应",
    Callback = function()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描中",
            Text = "正在执行服务器扫描...",
            Duration = 3
        })
        local anomalies = ServerScan()
        StarterGui:SetCore("SendNotification", {
            Title = "服务器扫描完成",
            Text = "检测到 " .. anomalies .. " 个异常",
            Duration = 5
        })
    end
})

Tabs.ScanTab:Section({Title = "扫描模式"})

Tabs.ScanTab:Toggle({
    Title = "隐身模式",
    Desc = "启用后会伪装扫描器活动",
    Default = false,
    Callback = function(state)
        local isEnabled = ToggleStealthMode()
        StarterGui:SetCore("SendNotification", {
            Title = "隐身模式",
            Text = isEnabled and "隐身模式已启用!" or "隐身模式已禁用!",
            Duration = 2
        })
    end
})

Tabs.ScanTab:Toggle({
    Title = "自动扫描",
    Desc = "自动定期执行扫描",
    Default = false,
    Callback = function(state)
        if state then
            spawn(function()
                while state do
                    wait(60)
                    BasicScan()
                end
            end)
        end
        StarterGui:SetCore("SendNotification", {
            Title = "自动扫描",
            Text = state and "自动扫描已启用!" or "自动扫描已禁用!",
            Duration = 2
        })
    end
})

Tabs.ResultsTab:Section({Title = "扫描结果"})

Tabs.ResultsTab:Button({
    Title = "查看脚本结果",
    Desc = "显示所有扫描到的脚本",
    Callback = function()
        local resultText = #ScriptPaths > 0 and table.concat(ScriptPaths, "\n") or "暂无脚本扫描结果"
        if setclipboard then
            setclipboard(resultText)
            StarterGui:SetCore("SendNotification", {
                Title = "脚本结果",
                Text = "已复制 " .. #ScriptPaths .. " 个脚本路径到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.ResultsTab:Button({
    Title = "查看远程结果",
    Desc = "显示所有扫描到的远程事件",
    Callback = function()
        local resultText = #RemotePaths > 0 and table.concat(RemotePaths, "\n") or "暂无远程扫描结果"
        if setclipboard then
            setclipboard(resultText)
            StarterGui:SetCore("SendNotification", {
                Title = "远程结果",
                Text = "已复制 " .. #RemotePaths .. " 个远程路径到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.ResultsTab:Button({
    Title = "查看威胁摘要",
    Desc = "显示威胁统计信息",
    Callback = function()
        local summary = GetThreatSummary()
        local summaryText = "威胁摘要:\n总计: " .. summary.total .. "\n高风险: " .. summary.high .. "\n中风险: " .. summary.medium .. "\n低风险: " .. summary.low
        if setclipboard then
            setclipboard(summaryText)
        end
        StarterGui:SetCore("SendNotification", {
            Title = "威胁摘要",
            Text = summaryText,
            Duration = 5
        })
    end
})

Tabs.ResultsTab:Button({
    Title = "查看所有日志",
    Desc = "显示完整扫描日志",
    Callback = function()
        local logText = #AllLogs > 0 and table.concat(AllLogs, "\n") or "暂无日志"
        if setclipboard then
            setclipboard(logText)
            StarterGui:SetCore("SendNotification", {
                Title = "日志",
                Text = "已复制 " .. #AllLogs .. " 条日志到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.ResultsTab:Button({
    Title = "清除所有结果",
    Desc = "清空所有扫描数据",
    Callback = function()
        ClearAllData()
        StarterGui:SetCore("SendNotification", {
            Title = "已清除",
            Text = "所有扫描结果已清除!",
            Duration = 2
        })
    end
})

Tabs.SettingsTab:Section({Title = "扫描器设置"})

Tabs.SettingsTab:Slider({
    Title = "扫描延迟 (秒)",
    Desc = "每个项目之间的扫描延迟",
    Value = {
        Min = 0,
        Max = 5,
        Default = 0.1
    },
    Callback = function(value)
        _G.ScanDelay = value
    end
})

Tabs.SettingsTab:Dropdown({
    Title = "扫描深度",
    Desc = "选择扫描的深度级别",
    Multi = false,
    Value = "中等",
    AllowNone = false,
    Values = {"浅层", "中等", "深层", "完整"},
    Callback = function(value)
        _G.ScanDepth = value
        StarterGui:SetCore("SendNotification", {
            Title = "扫描深度",
            Text = "已设置为: " .. value,
            Duration = 2
        })
    end
})

Tabs.SettingsTab:Toggle({
    Title = "反踢保护",
    Desc = "阻止游戏踢出玩家",
    Default = false,
    Callback = function(state)
        if state then
            BlockKickAttempts()
        end
        StarterGui:SetCore("SendNotification", {
            Title = "反踢保护",
            Text = state and "已启用!" or "已禁用!",
            Duration = 2
        })
    end
})

Tabs.SettingsTab:Toggle({
    Title = "反封禁保护",
    Desc = "尝试阻止封禁操作",
    Default = false,
    Callback = function(state)
        if state then
            pcall(BlockBanAttempts)
        end
        StarterGui:SetCore("SendNotification", {
            Title = "反封禁保护",
            Text = state and "已启用!" or "已禁用!",
            Duration = 2
        })
    end
})

Tabs.SettingsTab:Toggle({
    Title = "防挂机",
    Desc = "防止因闲置被踢出",
    Default = true,
    Callback = function(state)
        if state then
            SetupAntiAFK()
        end
        StarterGui:SetCore("SendNotification", {
            Title = "防挂机",
            Text = state and "已启用!" or "已禁用!",
            Duration = 2
        })
    end
})

Tabs.SettingsTab:Keybind({
    Title = "切换界面快捷键",
    Desc = "按下快捷键显示/隐藏界面",
    Value = Enum.KeyCode.RightControl,
    CanBeEmpty = false,
    Callback = function(key)
        Window:ToggleVisibility()
    end
})

Tabs.ToolsTab:Section({Title = "实用工具"})

Tabs.ToolsTab:Button({
    Title = "检测漏洞函数",
    Desc = "扫描可用的漏洞/钩子函数",
    Callback = function()
        local detected = DetectExploitHooks()
        StarterGui:SetCore("SendNotification", {
            Title = "漏洞函数检测",
            Text = "检测到 " .. #detected .. " 个漏洞函数",
            Duration = 3
        })
    end
})

Tabs.ToolsTab:Button({
    Title = "扫描CoreGui",
    Desc = "扫描CoreGui中的元素",
    Callback = function()
        ScanCoreGui()
        StarterGui:SetCore("SendNotification", {
            Title = "CoreGui扫描",
            Text = "CoreGui扫描完成! 发现 " .. #CoreGuiElements .. " 个元素",
            Duration = 3
        })
    end
})

Tabs.ToolsTab:Button({
    Title = "扫描反作弊逻辑",
    Desc = "查找游戏中的反作弊代码",
    Callback = function()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描中",
            Text = "正在扫描反作弊逻辑...",
            Duration = 2
        })
        ScanAntiCheatLogic()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描完成",
            Text = "反作弊逻辑扫描完成!",
            Duration = 3
        })
    end
})

Tabs.ToolsTab:Button({
    Title = "测试服务器逻辑",
    Desc = "发送测试数据到服务器",
    Callback = function()
        StarterGui:SetCore("SendNotification", {
            Title = "测试中",
            Text = "正在测试服务器逻辑...",
            Duration = 2
        })
        TestServerLogic()
        StarterGui:SetCore("SendNotification", {
            Title = "测试完成",
            Text = "服务器逻辑测试完成!",
            Duration = 3
        })
    end
})

Tabs.ToolsTab:Button({
    Title = "部署防御层",
    Desc = "激活所有防御机制",
    Callback = function()
        DeployDefenseLayers()
        StarterGui:SetCore("SendNotification", {
            Title = "防御层",
            Text = "防御层部署中...",
            Duration = 3
        })
    end
})

Tabs.ToolsTab:Button({
    Title = "检测VPN/代理",
    Desc = "通过延迟检测VPN或代理",
    Callback = function()
        DetectVPNProxy()
        StarterGui:SetCore("SendNotification", {
            Title = "VPN检测",
            Text = "VPN/代理检测完成!",
            Duration = 3
        })
    end
})

Tabs.ServerTab:Section({Title = "服务器分析"})

Tabs.ServerTab:Button({
    Title = "检测加密远程",
    Desc = "查找加密相关的远程事件",
    Callback = function()
        DetectNetworkEncryption()
        StarterGui:SetCore("SendNotification", {
            Title = "加密检测",
            Text = "加密远程检测完成!",
            Duration = 3
        })
    end
})

Tabs.ServerTab:Button({
    Title = "检测验证远程",
    Desc = "查找验证相关的远程事件",
    Callback = function()
        DetectCrossServerVerification()
        StarterGui:SetCore("SendNotification", {
            Title = "验证检测",
            Text = "验证远程检测完成!",
            Duration = 3
        })
    end
})

Tabs.ServerTab:Button({
    Title = "检测管理员",
    Desc = "检测服务器中的管理员玩家",
    Callback = function()
        DetectAdminPlayers()
        StarterGui:SetCore("SendNotification", {
            Title = "管理员检测",
            Text = "管理员检测完成!",
            Duration = 3
        })
    end
})

Tabs.ServerTab:Button({
    Title = "测试复制延迟",
    Desc = "测试客户端到服务器的复制延迟",
    Callback = function()
        TestReplicationLag()
        StarterGui:SetCore("SendNotification", {
            Title = "延迟测试",
            Text = "复制延迟测试已启动!",
            Duration = 3
        })
    end
})

Tabs.ServerTab:Button({
    Title = "查看服务器日志",
    Desc = "显示所有服务器相关日志",
    Callback = function()
        local logText = #ServerLogs > 0 and table.concat(ServerLogs, "\n\n") or "暂无服务器日志"
        if setclipboard then
            setclipboard(logText)
            StarterGui:SetCore("SendNotification", {
                Title = "服务器日志",
                Text = "已复制 " .. #ServerLogs .. " 条日志到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.MemoryTab:Section({Title = "内存分析"})

Tabs.MemoryTab:Button({
    Title = "扫描内存",
    Desc = "扫描内存中的可疑函数和表",
    Callback = function()
        StarterGui:SetCore("SendNotification", {
            Title = "扫描中",
            Text = "正在扫描内存...",
            Duration = 2
        })
        local findings = ScanMemory()
        StarterGui:SetCore("SendNotification", {
            Title = "内存扫描完成",
            Text = "发现 " .. #findings .. " 个可疑项目",
            Duration = 3
        })
    end
})

Tabs.MemoryTab:Button({
    Title = "查看内存转储",
    Desc = "显示所有内存转储数据",
    Callback = function()
        local dumpText = #MemoryDumps > 0 and table.concat(MemoryDumps, "\n\n") or "暂无内存转储"
        if setclipboard then
            setclipboard(dumpText)
            StarterGui:SetCore("SendNotification", {
                Title = "内存转储",
                Text = "已复制 " .. #MemoryDumps .. " 条转储到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.MemoryTab:Button({
    Title = "内存操作测试",
    Desc = "测试内存读写能力",
    Callback = function()
        ManipulateMemory()
        StarterGui:SetCore("SendNotification", {
            Title = "内存操作",
            Text = "内存操作测试完成!",
            Duration = 3
        })
    end
})

Tabs.MemoryTab:Paragraph({
    Title = "内存状态",
    Desc = "当前内存使用: " .. math.floor(collectgarbage("count")) .. " KB",
    Image = "rbxassetid://129260712070622",
    ImageSize = 30,
    ThumbnailSize = 60
})

Tabs.NetworkTab:Section({Title = "网络监控"})

Tabs.NetworkTab:Button({
    Title = "启动网络监控",
    Desc = "开始监控所有远程调用",
    Callback = function()
        MonitorNetworkCalls()
        StarterGui:SetCore("SendNotification", {
            Title = "网络监控",
            Text = "网络监控已启动!",
            Duration = 3
        })
    end
})

Tabs.NetworkTab:Button({
    Title = "查看网络日志",
    Desc = "显示所有网络活动日志",
    Callback = function()
        local logText = #NetworkLogs > 0 and table.concat(NetworkLogs, "\n\n") or "暂无网络日志"
        if setclipboard then
            setclipboard(logText)
            StarterGui:SetCore("SendNotification", {
                Title = "网络日志",
                Text = "已复制 " .. #NetworkLogs .. " 条日志到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.NetworkTab:Toggle({
    Title = "自动记录网络",
    Desc = "自动记录所有网络活动",
    Default = false,
    Callback = function(state)
        if state then
            MonitorNetworkCalls()
        end
        StarterGui:SetCore("SendNotification", {
            Title = "网络记录",
            Text = state and "已启用!" or "已禁用!",
            Duration = 2
        })
    end
})

Tabs.BehaviorTab:Section({Title = "行为分析"})

Tabs.BehaviorTab:Button({
    Title = "启动物理监控",
    Desc = "监控角色物理异常",
    Callback = function()
        pcall(MonitorPhysics)
        StarterGui:SetCore("SendNotification", {
            Title = "物理监控",
            Text = "物理监控已启动!",
            Duration = 3
        })
    end
})

Tabs.BehaviorTab:Button({
    Title = "启动音频监控",
    Desc = "监控可疑音频事件",
    Callback = function()
        MonitorAudio()
        StarterGui:SetCore("SendNotification", {
            Title = "音频监控",
            Text = "音频监控已启动!",
            Duration = 3
        })
    end
})

Tabs.BehaviorTab:Button({
    Title = "启动帧率监控",
    Desc = "监控帧率异常",
    Callback = function()
        MonitorFPS()
        StarterGui:SetCore("SendNotification", {
            Title = "帧率监控",
            Text = "帧率监控已启动!",
            Duration = 3
        })
    end
})

Tabs.BehaviorTab:Button({
    Title = "查看行为日志",
    Desc = "显示所有行为模式日志",
    Callback = function()
        local logText = #BehaviorPatterns > 0 and table.concat(BehaviorPatterns, "\n\n") or "暂无行为日志"
        if setclipboard then
            setclipboard(logText)
            StarterGui:SetCore("SendNotification", {
                Title = "行为日志",
                Text = "已复制 " .. #BehaviorPatterns .. " 条日志到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.BehaviorTab:Button({
    Title = "查看物理异常",
    Desc = "显示所有物理异常日志",
    Callback = function()
        local logText = #PhysicsAnomalies > 0 and table.concat(PhysicsAnomalies, "\n\n") or "暂无物理异常"
        if setclipboard then
            setclipboard(logText)
            StarterGui:SetCore("SendNotification", {
                Title = "物理异常",
                Text = "已复制 " .. #PhysicsAnomalies .. " 条日志到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.BehaviorTab:Toggle({
    Title = "行为伪装",
    Desc = "模拟人类输入以规避检测",
    Default = false,
    Callback = function(state)
        if state then
            BehavioralCamouflage()
        end
        StarterGui:SetCore("SendNotification", {
            Title = "行为伪装",
            Text = state and "已启用!" or "已禁用!",
            Duration = 2
        })
    end
})

Tabs.ExportTab:Section({Title = "数据导出"})

Tabs.ExportTab:Button({
    Title = "导出所有数据",
    Desc = "将所有扫描数据导出到剪贴板",
    Callback = function()
        ExportAllData()
    end
})

Tabs.ExportTab:Button({
    Title = "导出JSON格式",
    Desc = "以JSON格式导出数据",
    Callback = function()
        local exportData = {
            Scripts = ScriptPaths,
            Remotes = RemotePaths,
            Network = NetworkLogs,
            Memory = MemoryDumps,
            Behavior = BehaviorPatterns,
            Physics = PhysicsAnomalies,
            Audio = AudioEvents,
            Execution = ExecutionLogs,
            Server = ServerLogs,
            CoreGui = CoreGuiElements,
            Logs = AllLogs,
            AIPatterns = AIPatterns,
            ScriptSignatures = ScriptSignatures,
            PeerData = PeerData,
            ThreatSummary = GetThreatSummary()
        }
        local jsonText = HttpService:JSONEncode(exportData)
        if setclipboard then
            setclipboard(jsonText)
            StarterGui:SetCore("SendNotification", {
                Title = "JSON导出",
                Text = "JSON数据已导出到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.ExportTab:Button({
    Title = "导出威胁报告",
    Desc = "生成详细的威胁分析报告",
    Callback = function()
        local summary = GetThreatSummary()
        local report = "=== 威胁分析报告 ===\n"
        report = report .. "生成时间: " .. os.date("%Y-%m-%d %H:%M:%S") .. "\n"
        report = report .. "游戏ID: " .. game.PlaceId .. "\n"
        report = report .. "服务器ID: " .. game.JobId .. "\n\n"
        report = report .. "--- 威胁摘要 ---\n"
        report = report .. "总威胁数: " .. summary.total .. "\n"
        report = report .. "高风险: " .. summary.high .. "\n"
        report = report .. "中风险: " .. summary.medium .. "\n"
        report = report .. "低风险: " .. summary.low .. "\n\n"
        report = report .. "--- 威胁详情 ---\n"
        for i, threat in ipairs(ThreatList) do
            report = report .. i .. ". [" .. threat.status .. "] " .. (threat.type or "未知") .. "\n"
            if threat.path then
                report = report .. "   路径: " .. threat.path .. "\n"
            end
            if threat.details then
                report = report .. "   详情: " .. threat.details:sub(1, 200) .. "\n"
            end
        end
        if setclipboard then
            setclipboard(report)
            StarterGui:SetCore("SendNotification", {
                Title = "威胁报告",
                Text = "威胁报告已导出到剪贴板!",
                Duration = 3
            })
        end
    end
})

Tabs.ExportTab:Button({
    Title = "发送到Discord",
    Desc = "将报告发送到Discord Webhook",
    Callback = function()
        if DiscordWebhookURL == "" then
            StarterGui:SetCore("SendNotification", {
                Title = "错误",
                Text = "请先设置Discord Webhook URL!",
                Duration = 3
            })
            return
        end
        local summary = GetThreatSummary()
        local webhookData = {
            content = "反作弊扫描器报告",
            embeds = {{
                title = "扫描报告",
                description = "游戏ID: " .. game.PlaceId,
                color = summary.high > 0 and 16711680 or 65280,
                fields = {
                    {name = "总威胁", value = tostring(summary.total), inline = true},
                    {name = "高风险", value = tostring(summary.high), inline = true},
                    {name = "中风险", value = tostring(summary.medium), inline = true},
                    {name = "低风险", value = tostring(summary.low), inline = true}
                },
                timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
            }}
        }
        pcall(function()
            local http = game:GetService("HttpService")
            http:PostAsync(DiscordWebhookURL, http:JSONEncode(webhookData))
        end)
        StarterGui:SetCore("SendNotification", {
            Title = "Discord",
            Text = "报告已发送到Discord!",
            Duration = 3
        })
    end
})

Tabs.ExportTab:Input({
    Title = "Discord Webhook URL",
    Desc = "设置Discord Webhook URL",
    Value = "",
    PlaceholderText = "输入Webhook URL...",
    ClearAfterInput = false,
    Callback = function(value)
        DiscordWebhookURL = value
        StarterGui:SetCore("SendNotification", {
            Title = "Webhook",
            Text = "Webhook URL已设置!",
            Duration = 2
        })
    end
})

Window:Notify({
    Title = "反作弊扫描器 Pro",
    Desc = "扫描器已成功加载!\n使用侧边栏导航各功能模块",
    Duration = 5
})

task.spawn(function()
    InitializeAllSystems()
    StarterGui:SetCore("SendNotification", {
        Title = "系统初始化",
        Text = "所有后台系统已启动!",
        Duration = 3
    })
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == ToggleKey then
        Window:ToggleVisibility()
    elseif input.KeyCode == AdvancedScanKey then
        AdvancedScan()
        StarterGui:SetCore("SendNotification", {
            Title = "高级扫描",
            Text = "高级扫描已通过快捷键触发!",
            Duration = 2
        })
    elseif input.KeyCode == StealthKey then
        ToggleStealthMode()
        StarterGui:SetCore("SendNotification", {
            Title = "隐身模式",
            Text = StealthMode and "隐身模式已启用!" or "隐身模式已禁用!",
            Duration = 2
        })
    elseif input.KeyCode == QuickScanKey then
        QuickScan()
        StarterGui:SetCore("SendNotification", {
            Title = "快速扫描",
            Text = "快速扫描已通过快捷键触发!",
            Duration = 2
        })
    elseif input.KeyCode == ExportKey then
        ExportAllData()
    elseif input.KeyCode == ServerScanKey then
        ServerScan()
        StarterGui:SetCore("SendNotification", {
            Title = "服务器扫描",
            Text = "服务器扫描已通过快捷键触发!",
            Duration = 2
        })
    end
end)

return {
    BasicScan = BasicScan,
    QuickScan = QuickScan,
    AdvancedScan = AdvancedScan,
    ServerScan = ServerScan,
    ExportAllData = ExportAllData,
    ToggleStealthMode = ToggleStealthMode,
    GetThreatSummary = GetThreatSummary,
    ClearAllData = ClearAllData,
    Window = Window,
    Tabs = Tabs
}